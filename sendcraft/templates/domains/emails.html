{% extends "base.html" %}

{% block title %}{{ page_title }} - SendCraft{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('web.dashboard') }}"><i class="bi bi-house"></i> Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('web.domains_list') }}">Domínios</a></li>
                <li class="breadcrumb-item active">{{ domain.name }}</li>
            </ol>
        </nav>
        <h1 class="h2">
            <i class="bi bi-envelope me-2"></i>
            Emails - {{ domain.name }}
        </h1>
        <p class="text-muted">Visão consolidada de emails recebidos e enviados</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" id="syncAllBtn">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Sincronizar Todas as Contas
        </button>
        <a href="{{ url_for('web.domains_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Voltar
        </a>
    </div>
</div>

<!-- Estatísticas -->
<div class="row mb-4" id="statsContainer">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-0">Recebidos (Total)</h6>
                        <h3 class="mb-0" id="statsReceivedTotal">-</h3>
                    </div>
                    <i class="bi bi-envelope-check text-primary" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-0">Não Lidos</h6>
                        <h3 class="mb-0" id="statsUnread">-</h3>
                    </div>
                    <i class="bi bi-envelope-exclamation text-warning" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-0">Recebidos Hoje</h6>
                        <h3 class="mb-0" id="statsReceivedToday">-</h3>
                    </div>
                    <i class="bi bi-envelope-plus text-info" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-0">Enviados (30d)</h6>
                        <h3 class="mb-0" id="statsSent30d">-</h3>
                    </div>
                    <i class="bi bi-send text-success" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="emailTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab">
            <i class="bi bi-inbox me-1"></i>
            Recebidos
            <span class="badge bg-secondary ms-2" id="receivedCount">-</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">
            <i class="bi bi-send me-1"></i>
            Enviados
            <span class="badge bg-secondary ms-2" id="sentCount">-</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="unread-tab" data-bs-toggle="tab" data-bs-target="#unread" type="button" role="tab">
            <i class="bi bi-envelope-exclamation me-1"></i>
            Não Lidos
            <span class="badge bg-warning ms-2" id="unreadCount">-</span>
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="emailTabsContent">
    <!-- Recebidos -->
    <div class="tab-pane fade show active" id="received" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Últimos Emails Recebidos</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="loadReceivedEmails()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="receivedEmailsList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">A carregar...</span>
                        </div>
                        <p class="mt-3 text-muted">A carregar emails recebidos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enviados -->
    <div class="tab-pane fade" id="sent" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Últimos Emails Enviados</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="loadSentEmails()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="sentEmailsList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">A carregar...</span>
                        </div>
                        <p class="mt-3 text-muted">A carregar emails enviados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Não Lidos -->
    <div class="tab-pane fade" id="unread" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Emails Não Lidos</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="loadUnreadEmails()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="unreadEmailsList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">A carregar...</span>
                        </div>
                        <p class="mt-3 text-muted">A carregar emails não lidos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastContainer"></div>
</div>

<script>
const domainId = {{ domain.id }};

// Função para mostrar toast
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.getElementById('toastContainer').appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 5000);
}

// Sincronizar todas as contas
document.getElementById('syncAllBtn').addEventListener('click', async function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>A sincronizar...';
    
    try {
        const response = await fetch(`/api/v1/domains/${domainId}/sync-all`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                folder: 'INBOX',
                limit: 50,
                full_sync: false
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`Sincronização concluída! ${result.total_synced} emails sincronizados de ${result.synced_accounts}/${result.total_accounts} contas.`, 'success');
            // Recarregar dados
            loadStats();
            loadReceivedEmails();
            loadSentEmails();
            loadUnreadEmails();
        } else {
            throw new Error(result.error || 'Erro na sincronização');
        }
    } catch (error) {
        console.error('Sync error:', error);
        showToast(`Erro na sincronização: ${error.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});

// Carregar estatísticas
async function loadStats() {
    try {
        const response = await fetch(`/api/v1/domains/${domainId}/stats`);
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('statsReceivedTotal').textContent = result.received.total || 0;
            document.getElementById('statsUnread').textContent = result.received.unread || 0;
            document.getElementById('statsReceivedToday').textContent = result.received.today || 0;
            document.getElementById('statsSent30d').textContent = result.sent.last_30_days || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Carregar emails recebidos
async function loadReceivedEmails() {
    const container = document.getElementById('receivedEmailsList');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch(`/api/v1/domains/${domainId}/emails/received?limit=50&days=30`);
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('receivedCount').textContent = result.count;
            
            if (result.emails.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">Nenhum email recebido</p></div>';
                return;
            }
            
            let html = '<div class="list-group">';
            result.emails.forEach(email => {
                const date = new Date(email.received_at);
                const dateStr = date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="list-group-item list-group-item-action ${!email.is_read ? 'list-group-item-warning' : ''}">
                        <div class="d-flex w-100 justify-content-between">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${email.from_name || email.from_address}
                                    ${!email.is_read ? '<span class="badge bg-warning ms-2">Não lido</span>' : ''}
                                    ${email.is_flagged ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                    ${email.has_attachments ? '<i class="bi bi-paperclip ms-1"></i>' : ''}
                                </h6>
                                <p class="mb-1"><strong>${email.subject || '(Sem assunto)'}</strong></p>
                                <small class="text-muted">${email.account_email} • ${email.body_preview || ''}</small>
                            </div>
                            <small class="text-muted">${dateStr}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails recebidos</div>';
        }
    } catch (error) {
        console.error('Error loading received emails:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails recebidos</div>';
    }
}

// Carregar emails enviados
async function loadSentEmails() {
    const container = document.getElementById('sentEmailsList');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch(`/api/v1/domains/${domainId}/emails/sent?limit=50&days=30`);
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('sentCount').textContent = result.count;
            
            if (result.emails.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-send" style="font-size: 3rem;"></i><p class="mt-3">Nenhum email enviado</p></div>';
                return;
            }
            
            let html = '<div class="list-group">';
            result.emails.forEach(email => {
                const date = new Date(email.sent_at);
                const dateStr = date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                const statusClass = email.status === 'sent' || email.status === 'delivered' ? 'success' : 
                                     email.status === 'failed' ? 'danger' : 'warning';
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    Para: ${email.recipient_email}
                                    <span class="badge bg-${statusClass} ms-2">${email.status}</span>
                                </h6>
                                <p class="mb-1"><strong>${email.subject || '(Sem assunto)'}</strong></p>
                                <small class="text-muted">De: ${email.account_email}</small>
                            </div>
                            <small class="text-muted">${dateStr}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails enviados</div>';
        }
    } catch (error) {
        console.error('Error loading sent emails:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails enviados</div>';
    }
}

// Carregar emails não lidos
async function loadUnreadEmails() {
    const container = document.getElementById('unreadEmailsList');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch(`/api/v1/domains/${domainId}/emails/unread?limit=100`);
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('unreadCount').textContent = result.count;
            
            if (result.emails.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-check-circle" style="font-size: 3rem;"></i><p class="mt-3">Todos os emails foram lidos!</p></div>';
                return;
            }
            
            let html = '<div class="list-group">';
            result.emails.forEach(email => {
                const date = new Date(email.received_at);
                const dateStr = date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="list-group-item list-group-item-warning">
                        <div class="d-flex w-100 justify-content-between">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${email.from_name || email.from_address}
                                    ${email.is_flagged ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                    ${email.has_attachments ? '<i class="bi bi-paperclip ms-1"></i>' : ''}
                                </h6>
                                <p class="mb-1"><strong>${email.subject || '(Sem assunto)'}</strong></p>
                                <small class="text-muted">${email.account_email} • ${email.body_preview || ''}</small>
                            </div>
                            <small class="text-muted">${dateStr}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails não lidos</div>';
        }
    } catch (error) {
        console.error('Error loading unread emails:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar emails não lidos</div>';
    }
}

// Carregar dados iniciais
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadReceivedEmails();
    
    // Carregar quando mudar de tab
    document.getElementById('sent-tab').addEventListener('shown.bs.tab', function() {
        if (document.getElementById('sentEmailsList').innerHTML.includes('A carregar')) {
            loadSentEmails();
        }
    });
    
    document.getElementById('unread-tab').addEventListener('shown.bs.tab', function() {
        if (document.getElementById('unreadEmailsList').innerHTML.includes('A carregar')) {
            loadUnreadEmails();
        }
    });
});
</script>
{% endblock %}

